<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bubble AI | Search & Emotion Engine</title>
    <style>
      :root {
        --bg: #ffffff;
        --text: #202124;
        --muted: #5f6368;
        --link: #1a73e8;
        --border: #dadce0;
        --shadow: 0 1px 6px rgba(32,33,36,.28);
        --accent-duck: #de5833;
        --accent-bubble: #4285f4;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: 'Google Sans', Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.5;
      }
      .container {
        max-width: 800px;
        margin: 10vh auto 0;
        padding: 0 20px;
        text-align: center;
        transition: margin 0.3s ease;
      }
      .container.has-results { margin-top: 3vh; }

      .logo { font-size: 72px; font-weight: 700; letter-spacing: -2px; margin-bottom: 30px; }
      .logo span:nth-child(1) { color: #4285f4; }
      .logo span:nth-child(2) { color: #ea4335; }
      .logo span:nth-child(3) { color: #fbbc05; }
      .logo span:nth-child(4) { color: #4285f4; }
      .logo span:nth-child(5) { color: #34a853; }
      .logo span:nth-child(6) { color: #ea4335; }

      .search-box-wrapper {
        position: relative;
        max-width: 600px;
        margin: 0 auto;
      }
      .search-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        border: 1px solid var(--border);
        border-radius: 30px;
        padding: 5px 20px;
        background: white;
        transition: box-shadow 0.2s;
      }
      .search-bar:hover, .search-bar:focus-within { box-shadow: var(--shadow); }
      
      .search-input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 16px;
        padding: 12px 0;
      }
      .search-button {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        color: var(--muted);
      }

      .status-bar {
        margin-top: 15px;
        font-size: 14px;
        color: var(--muted);
        min-height: 24px;
      }

      /* Emotion Dashboard */
      .emotion-panel {
        background: #f8f9fa;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        margin: 20px auto;
        text-align: left;
        display: none;
        animation: fadeIn 0.4s ease;
      }
      .emotion-panel h4 { margin: 0 0 10px; font-size: 14px; text-transform: uppercase; color: var(--muted); letter-spacing: 1px; }
      .emotion-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .emotion-tag { padding: 8px 12px; border-radius: 8px; background: white; border: 1px solid #eee; font-weight: 600; }

      .results-area { max-width: 800px; margin: 30px auto; text-align: left; }
      .result-item { padding: 15px 0; animation: slideUp 0.3s ease forwards; opacity: 0; }
      .result-title { font-size: 20px; margin: 0 0 4px; font-weight: 400; }
      .result-title a { color: var(--link); text-decoration: none; }
      .result-title a:hover { text-decoration: underline; }
      .result-url { color: #202124; font-size: 14px; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .result-snippet { font-size: 14px; color: #4d5156; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

      @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

      .loading-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--accent-bubble);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: none;
        margin: 20px auto;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      .footer { margin-top: 50px; padding: 20px; border-top: 1px solid #eee; font-size: 12px; color: var(--muted); }
    </style>
  </head>
  <body>
    <div class="container" id="main-container">
      <div class="logo">
        <span>B</span><span>u</span><span>b</span><span>b</span><span>l</span><span>e</span>
      </div>

      <div class="search-box-wrapper">
        <form id="bubble-form" class="search-bar" autocomplete="off">
          <input id="query" class="search-input" type="text" placeholder="Search or analyze emotion..." required />
          <button type="submit" class="search-button">
            <svg focusable="false" height="24px" viewBox="0 0 24 24" width="24px"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
          </button>
        </form>
      </div>

      <div id="loading" class="loading-spinner"></div>
      <div id="status" class="status-bar"></div>

      <!-- Advanced Emotion Dashboard -->
      <div id="emotion-panel" class="emotion-panel">
        <h4>Psychological Profile</h4>
        <div class="emotion-grid">
          <div class="emotion-tag">State: <span id="state-val" style="color: var(--link)">-</span></div>
          <div class="emotion-tag">Confidence: <span id="conf-val">-</span>%</div>
          <div class="emotion-tag">Tool: <span id="tool-val">-</span></div>
          <div class="emotion-tag">Valence: <span id="val-val">-</span></div>
        </div>
      </div>

      <div id="results" class="results-area"></div>

      <div class="footer">
        Bubble AI Engine v2.0 • Running on Koyeb • 
        <a href="/api/docs" style="color: inherit">API Documentation</a>
      </div>
    </div>

    <script>
      const form = document.getElementById('bubble-form');
      const input = document.getElementById('query');
      const status = document.getElementById('status');
      const results = document.getElementById('results');
      const loader = document.getElementById('loading');
      const container = document.getElementById('main-container');
      const emotionPanel = document.getElementById('emotion-panel');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const q = input.value.trim();
        if(!q) return;

        // Reset UI
        status.textContent = "Connecting to Bubble nodes...";
        results.innerHTML = "";
        emotionPanel.style.display = "none";
        loader.style.display = "block";
        container.classList.add('has-results');

        try {
          // Simultaneous fetch for speed
          const [searchRes, emoRes] = await Promise.all([
            fetch(`/search?q=${encodeURIComponent(q)}`).then(r => r.json()),
            fetch(`/classify?text=${encodeURIComponent(q)}`).then(r => r.json())
          ]);

          loader.style.display = "none";

          // 1. Handle Emotions
          if(emoRes && emoRes.primary_state) {
            emotionPanel.style.display = "block";
            document.getElementById('state-val').textContent = emoRes.primary_state;
            document.getElementById('conf-val').textContent = Math.round(emoRes.confidence * 100);
            document.getElementById('tool-val').textContent = emoRes.tool;
            document.getElementById('val-val').textContent = emoRes.psychological_profile?.valence || 0;
          }

          // 2. Handle Search Results
          const items = searchRes.results || [];
          if(items.length > 0) {
            status.textContent = `Found ${items.length} results in ${searchRes.search_time || 0}s`;
            results.innerHTML = items.map((item, index) => `
              <div class="result-item" style="animation-delay: ${index * 0.1}s">
                <div class="result-url">${item.url}</div>
                <h3 class="result-title"><a href="${item.url}" target="_blank">${item.title}</a></h3>
                <div class="result-snippet">${item.snippet}</div>
              </div>
            `).join('');
          } else {
            status.textContent = "No results found.";
            results.innerHTML = "<p>Try adjusting your keywords or checking the server logs.</p>";
          }

        } catch (err) {
          loader.style.display = "none";
          status.textContent = "Server offline or connection refused.";
          console.error("Bubble Error:", err);
        }
      });
    </script>
  </body>
</html>
